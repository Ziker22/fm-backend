{% extends "admin/base_site.html" %}
{% load i18n admin_urls %}

{% block title %}Review Scraped Place | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
<style>
    .review-container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .content-container {
        display: flex;
        flex-direction: row;
        flex-grow: 1;
        margin-bottom: 20px;
    }

    .left-panel {
        flex: 1;
        padding: 20px;
        border-right: 1px solid #ccc;
    }

    .right-panel {
        flex: 2;
        padding: 20px;
    }

    .actions-container {
        padding: 20px;
        border-top: 1px solid #ccc;
        text-align: right;
    }

    .field-label {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .field-value {
        margin-bottom: 15px;
    }

    .action-btn {
        margin-left: 10px;
    }

    .post-content {
        white-space: pre-wrap;
        margin-bottom: 20px;
    }

    .post-comments {
        white-space: pre-wrap;
    }

    .ai-response {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        display: none;
    }

    .ai-field {
        margin-bottom: 10px;
    }

    .ai-field-label {
        font-weight: bold;
        color: #495057;
    }

    .ai-field-value {
        margin-top: 3px;
    }

    .loading {
        display: inline-block;
        margin-left: 10px;
        font-style: italic;
        color: #6c757d;
    }

    .save-place-btn {
        display: block;
        margin-top: 15px;
        margin-bottom: 15px;
        padding: 8px 15px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .save-place-btn:hover {
        background-color: #218838;
    }

    .related-places {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
    }

    .related-places h3 {
        margin-top: 0;
        margin-bottom: 15px;
    }

    .place-item {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    .place-item:last-child {
        margin-bottom: 0;
    }

    .place-item a {
        color: #447e9b;
        text-decoration: none;
    }

    .place-item a:hover {
        color: #036;
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
    &rsaquo; <a href="{% url 'admin:scraping_scrapedplace_changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
    &rsaquo; {% trans 'Review' %}
</div>
{% endblock %}

{% block content %}
<div class="review-container">

    <div class="content-container">
        <!-- Left panel: ScrapedPlace details -->
        <div class="left-panel">
            <h2>Place Details</h2>

            <div class="field-label">Name:</div>
            <div class="field-value">{{ place.name }}</div>

            <div class="field-label">City:</div>
            <div class="field-value">{{ place.city }}</div>

            <div class="field-label">Types:</div>
            <div class="field-value">
                {% if place.types %}
                    <ul>
                    {% for type in place.types %}
                        <li>{{ type }}</li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <em>No types specified</em>
                {% endif %}
            </div>

            <div class="field-label">Processed:</div>
            <div class="field-value">{{ place.processed|yesno:"Yes,No" }}</div>

            <!-- AI Response Section -->
            <div id="ai-response" class="ai-response">
                <h3>AI Generated Information</h3>

                <div class="ai-field">
                    <div class="ai-field-label">Name:</div>
                    <div id="ai-name" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Types:</div>
                    <div id="ai-types" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Description:</div>
                    <div id="ai-description" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Location:</div>
                    <div id="ai-location" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Address:</div>
                    <div id="ai-address" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Age Range:</div>
                    <div id="ai-age-range" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Website:</div>
                    <div id="ai-website" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Admission:</div>
                    <div id="ai-admission" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Season:</div>
                    <div id="ai-season" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Stroller Friendly:</div>
                    <div id="ai-stroller" class="ai-field-value"></div>
                </div>

                <button id="save-place-btn" class="save-place-btn" data-place-id="{{ place.id }}">Save as place</button>
                <button id="get-geo-btn" class="save-place-btn" data-place-id="{{ place.id }}">Get GEO</button>
            </div>

            <!-- Related Places Section -->
            <div id="related-places" class="related-places" {% if not related_places %}style="display: none;"{% endif %}>
                <h3>Related Places</h3>

                <div id="related-places-list">
                    {% if related_places %}
                        {% for place in related_places %}
                            <div class="place-item">
                                <div><strong>Name:</strong> <a href="{% url 'admin:place_place_change' place.id %}">{{ place.name }}</a></div>
                                <div><strong>Types:</strong> {{ place.type|join:", " }}</div>
                                <div><strong>City:</strong> {{ place.city }}</div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p><em>No related places found</em></p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right panel: ScrapedPost details -->
        <div class="right-panel">
            <h2>Related Post</h2>

            {% if post %}
                <div class="field-label">Title:</div>
                <div class="field-value">{{ post.title }}</div>

                <div class="field-label">Post created:</div>
                <div class="field-value">{{ post.original_created_at }}</div>

                <div class="field-label">Content:</div>
                <div class="field-value post-content">{{ post.content }}</div>

                <div class="field-label">Comments:</div>
                <div class="field-value post-comments">
                    {% if post.comments %}
                        {% for comment in post.comments %}
{{ comment }}
                        {% endfor %}
                    {% else %}
                        <em>No comments</em>
                    {% endif %}
                </div>
            {% else %}
                <p><em>No related post found</em></p>
            {% endif %}
        </div>
    </div>

    <!-- Actions container -->
    <div class="actions-container">
        <button id="ask-ai-btn" class="button action-btn" data-place-id="{{ place.id }}">AskAI <span id="loading" class="loading" style="display: none;">Processing...</span></button>
        <a href="{% url 'admin:scraping_scrapedplace_changelist' %}" class="button action-btn">Cancel</a>
        <a href="{% url 'admin:scraping_scrapedplace_mark_processed' place.id %}" class="button default action-btn">Mark as Processed</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const askAiBtn = document.getElementById('ask-ai-btn');
        const savePlaceBtn = document.getElementById('save-place-btn');
        const getGeoBtn = document.getElementById('get-geo-btn');
        const aiResponse = document.getElementById('ai-response');
        const relatedPlaces = document.getElementById('related-places');
        const relatedPlacesList = document.getElementById('related-places-list');
        const loading = document.getElementById('loading');

        // Store the AI response data globally
        let aiResponseData = null;

        askAiBtn.addEventListener('click', function() {
            const placeId = this.getAttribute('data-place-id');

            // Show loading indicator
            loading.style.display = 'inline-block';

            // Make API call
            fetch(`/admin/scraping/scrapedplace/ask_ai/${placeId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Store the AI response data
                    aiResponseData = data;

                    // Hide loading indicator
                    loading.style.display = 'none';

                    // Update UI with response
                    document.getElementById('ai-name').textContent = data.name || '';

                    // Handle types array
                    if (data.types && Array.isArray(data.types)) {
                        document.getElementById('ai-types').textContent = data.types.join(', ');
                    } else {
                        document.getElementById('ai-types').textContent = '';
                    }

                    document.getElementById('ai-description').textContent = data.description || '';

                    // Format location
                    if (data.lat && data.lon) {
                        document.getElementById('ai-location').textContent = `${data.lat}, ${data.lon}`;
                    } else {
                        document.getElementById('ai-location').textContent = '';
                    }

                    // Format address
                    const address = [];
                    if (data.street) address.push(data.street);
                    if (data.city) address.push(data.city);
                    if (data.zip_code) address.push(data.zip_code);
                    if (data.country_code) address.push(data.country_code);
                    document.getElementById('ai-address').textContent = address.join(', ');

                    // Format age range
                    if (data.min_age !== undefined && data.max_age !== undefined) {
                        document.getElementById('ai-age-range').textContent = `${data.min_age} - ${data.max_age} years`;
                    } else {
                        document.getElementById('ai-age-range').textContent = '';
                    }

                    // Website with link
                    if (data.website) {
                        const link = document.createElement('a');
                        link.href = data.website;
                        link.textContent = data.website;
                        link.target = '_blank';
                        document.getElementById('ai-website').innerHTML = '';
                        document.getElementById('ai-website').appendChild(link);
                    } else {
                        document.getElementById('ai-website').textContent = '';
                    }

                    // Admission
                    if (data.is_admission_free !== undefined) {
                        document.getElementById('ai-admission').textContent = data.is_admission_free ? 'Free' : 'Paid';
                    } else {
                        document.getElementById('ai-admission').textContent = 'Unknown';
                    }

                    // Season
                    document.getElementById('ai-season').textContent = data.season || '';

                    // Stroller friendly
                    if (data.stroller_friendly !== undefined) {
                        document.getElementById('ai-stroller').textContent = data.stroller_friendly ? 'Yes' : 'No';
                    } else {
                        document.getElementById('ai-stroller').textContent = 'Unknown';
                    }

                    // Show the AI response section
                    aiResponse.style.display = 'block';
                })
                .catch(error => {
                    // Hide loading indicator
                    loading.style.display = 'none';

                    console.error('Error:', error);
                    alert('Error fetching AI response: ' + error.message);
                });
        });

        // Handle Save as place button click
        savePlaceBtn.addEventListener('click', function() {
            if (!aiResponseData) {
                alert('No AI response data available. Please generate AI response first.');
                return;
            }

            const placeId = this.getAttribute('data-place-id');

            // Show loading indicator
            loading.style.display = 'inline-block';

            // Make API call to save the place
            fetch(`/admin/scraping/scrapedplace/save_as_place/${placeId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(aiResponseData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Hide loading indicator
                loading.style.display = 'none';

                if (data.success) {
                    // Show success message
                    alert(data.message);

                    // Update related places section
                    updateRelatedPlaces(data.related_places);
                } else {
                    alert('Error saving place: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                // Hide loading indicator
                loading.style.display = 'none';

                console.error('Error:', error);
                alert('Error saving place: ' + error.message);
            });
        });

        // Handle Get GEO button click
        getGeoBtn.addEventListener('click', function() {
            if (!aiResponseData) {
                alert('No AI response data available. Please generate AI response first.');
                return;
            }

            // Show loading indicator
            loading.style.display = 'inline-block';

            // Extract address components from AI response data
            const street = aiResponseData.street || '';
            const zipCode = aiResponseData.zip_code || '';
            const city = aiResponseData.city || '';
            const placeName = aiResponseData.name || '';
            const countryCode = aiResponseData.country_code || 'us';

            const placeId = this.getAttribute('data-place-id');

            // Call the geocode_place endpoint
            fetch(`/admin/scraping/scrapedplace/geocode/${placeId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    street: street,
                    zip_code: zipCode,
                    city: city,
                    place_name: placeName,
                    country_code: countryCode
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Hide loading indicator
                loading.style.display = 'none';

                if (data.success) {
                    // Update the AI response data with the new lat/lon
                    aiResponseData.lat = data.lat;
                    aiResponseData.lon = data.lon;

                    // Update the UI
                    document.getElementById('ai-location').textContent = `${data.lat}, ${data.lon}`;

                    // Show success message
                    alert('Geocoding successful! Location updated.');
                } else {
                    alert('Error geocoding address: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                // Hide loading indicator
                loading.style.display = 'none';

                console.error('Error:', error);
                alert('Error geocoding address: ' + error.message);
            });
        });

        // Function to update related places section
        function updateRelatedPlaces(places) {
            // Clear existing content
            relatedPlacesList.innerHTML = '';

            if (places && places.length > 0) {
                // Add each place to the list
                places.forEach(place => {
                    const placeItem = document.createElement('div');
                    placeItem.className = 'place-item';

                    const nameDiv = document.createElement('div');
                    nameDiv.innerHTML = `<strong>Name:</strong> <a href="/admin/place/place/${place.id}/change/">${place.name}</a>`;
                    placeItem.appendChild(nameDiv);

                    const typesDiv = document.createElement('div');
                    typesDiv.innerHTML = `<strong>Types:</strong> ${Array.isArray(place.type) ? place.type.join(', ') : ''}`;
                    placeItem.appendChild(typesDiv);

                    const cityDiv = document.createElement('div');
                    cityDiv.innerHTML = `<strong>City:</strong> ${place.city || ''}`;
                    placeItem.appendChild(cityDiv);

                    relatedPlacesList.appendChild(placeItem);
                });
            } else {
                // Show no places message
                const noPlaces = document.createElement('p');
                noPlaces.innerHTML = '<em>No related places found</em>';
                relatedPlacesList.appendChild(noPlaces);
            }

            // Show the related places section
            relatedPlaces.style.display = 'block';
        }

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}
