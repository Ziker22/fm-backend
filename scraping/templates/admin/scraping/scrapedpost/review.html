{% extends "admin/base_site.html" %}
{% load i18n admin_urls %}

{% block title %}Review Scraped Post | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
<style>
    .review-container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .content-container {
        display: flex;
        flex-direction: row;
        flex-grow: 1;
        margin-bottom: 20px;
    }

    .left-panel {
        flex: 1;
        padding: 20px;
        border-right: 1px solid #ccc;
    }

    .right-panel {
        flex: 2;
        padding: 20px;
    }

    .actions-container {
        padding: 20px;
        border-top: 1px solid #ccc;
        text-align: right;
    }

    .field-label {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .field-value {
        margin-bottom: 15px;
    }

    .action-btn {
        margin-left: 10px;
    }

    .post-content {
        white-space: pre-wrap;
        margin-bottom: 20px;
    }

    .post-comments {
        white-space: pre-wrap;
    }

    .ai-response {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        display: none;
    }

    .ai-field {
        margin-bottom: 10px;
    }

    .ai-field-label {
        font-weight: bold;
        color: #495057;
    }

    .ai-field-value {
        margin-top: 3px;
    }

    .loading {
        display: inline-block;
        margin-left: 10px;
        font-style: italic;
        color: #6c757d;
    }

    .save-place-btn {
        display: block;
        margin-top: 15px;
        margin-bottom: 15px;
        padding: 8px 15px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .save-place-btn:hover {
        background-color: #218838;
    }

    .related-places {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
    }

    .related-places h3 {
        margin-top: 0;
        margin-bottom: 15px;
    }

    .place-item {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    .place-item:last-child {
        margin-bottom: 0;
    }

    .place-item a {
        color: #447e9b;
        text-decoration: none;
    }

    .place-item a:hover {
        color: #036;
        text-decoration: underline;
    }

    .selected-types-display {
        margin-bottom: 8px;
        padding: 5px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9em;
        line-height: 1.5;
        min-height: 20px;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
    &rsaquo; <a href="{% url 'admin:scraping_scrapedpost_changelist' %}">Scraped Posts</a>
    &rsaquo; {% trans 'Review' %}
</div>
{% endblock %}

{% block content %}
<div class="review-container">

    <div class="content-container">
        <!-- Left panel: ScrapedPost details -->
        <div class="left-panel">
            <h2>Post Details</h2>

            <div class="field-label">Title:</div>
            <div class="field-value">{{ post.title }}</div>

            <div class="field-label">Third Party Type:</div>
            <div class="field-value">{{ post.third_party_type }}</div>

            <div class="field-label">Probability:</div>
            <div class="field-value">{{ post.probability }}</div>

            <div class="field-label">Created At:</div>
            <div class="field-value">{{ post.original_created_at }}</div>

            <div class="field-label">Places:</div>
            <div class="field-value">
                {% if post.places.all %}
                    {{ post.places.all|join:", " }}
                {% else %}
                    <em>No places associated</em>
                {% endif %}
            </div>

            <div class="field-label">Processed:</div>
            <div class="field-value">{{ post.is_processed|yesno:"Yes,No" }}</div>

            <!-- AI Response Section -->
            <div id="ai-response" class="ai-response">
                <h3>AI Generated Information</h3>

                <div class="ai-field">
                    <div class="ai-field-label">Name:</div>
                    <div id="ai-name" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Types:</div>
                    <div id="selected-types-display" class="selected-types-display"></div>
                    <div class="ai-field-value">
                        <select id="ai-types" class="ai-field-value" multiple style="width: 100%; min-height: 100px;">
                            {% for type_value, type_name in place_types %}
                                <option value="{{ type_value }}">{{ type_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Description:</div>
                    <div id="ai-description" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Location:</div>
                    <div class="ai-field-value">
                        <input type="text" id="ai-location-lat" placeholder="Latitude" style="width: 120px; margin-right: 10px;">
                        <input type="text" id="ai-location-lon" placeholder="Longitude" style="width: 120px;">
                    </div>
                    <a id="google-maps-link" href="#" target="_blank">View on Google Maps</a>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Address:</div>
                    <div id="ai-address" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Age Range:</div>
                    <div id="ai-age-range" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Website:</div>
                    <div id="ai-website" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Admission:</div>
                    <div id="ai-admission" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Season:</div>
                    <div id="ai-season" class="ai-field-value"></div>
                </div>

                <div class="ai-field">
                    <div class="ai-field-label">Stroller Friendly:</div>
                    <div id="ai-stroller" class="ai-field-value"></div>
                </div>
                  <div class="ai-field">
                    <div class="ai-field-label">Car needed:</div>
                    <div id="ai-car-needed" class="ai-field-value"></div>
                </div>

                <button id="save-place-btn" class="save-place-btn" data-post-id="{{ post.id }}">Save as place</button>
                <button id="get-geo-btn" class="save-place-btn" data-post-id="{{ post.id }}">Get GEO</button>
            </div>

            <!-- Related Places Section -->
            <div id="related-places" class="related-places" {% if not related_places %}style="display: none;"{% endif %}>
                <h3>Related Places</h3>

                <div id="related-places-list">
                    {% if related_places %}
                        {% for place in related_places %}
                            <div class="place-item">
                                <div><strong>Name:</strong> <a href="{% url 'admin:place_place_change' place.id %}">{{ place.name }}</a></div>
                                <div><strong>Types:</strong> {{ place.type|join:", " }}</div>
                                <div><strong>City:</strong> {{ place.city }}</div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p><em>No related places found</em></p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right panel: ScrapedPost details -->
        <div class="right-panel">
            <h2>Related Post</h2>

            {% if post %}
                <div class="field-label">Title:</div>
                <div class="field-value">{{ post.title }}</div>

                <div class="field-label">Post created:</div>
                <div class="field-value">{{ post.original_created_at }}</div>

                <div class="field-label">Content:</div>
                <div class="field-value post-content">{{ post.content }}</div>

                <div class="field-label">Comments:</div>
                <div class="field-value post-comments">
                    {% if post.comments %}
                        {% for comment in post.comments %}
{{ comment }}
                        {% endfor %}
                    {% else %}
                        <em>No comments</em>
                    {% endif %}
                </div>
            {% else %}
                <p><em>No related post found</em></p>
            {% endif %}
        </div>
    </div>

    <!-- Actions container -->
    <div class="actions-container">
        <button id="ask-ai-selection-btn" class="button action-btn" data-post-id="{{ post.id }}">ASK AI from selection <span id="loading-selection" class="loading" style="display: none;">Processing...</span></button>
        <button id="ask-ai-input-btn" class="button action-btn" data-post-id="{{ post.id }}">Ask AI from input <span id="loading-input" class="loading" style="display: none;">Processing...</span></button>
        <a href="{% url 'admin:scraping_scrapedpost_changelist' %}" class="button action-btn">Cancel</a>
        <a href="{% url 'admin:scraping_scrapedpost_mark_processed' post.id %}" class="button default action-btn">Mark as Processed</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const askAiSelectionBtn = document.getElementById('ask-ai-selection-btn');
        const askAiInputBtn = document.getElementById('ask-ai-input-btn');
        const savePlaceBtn = document.getElementById('save-place-btn');
        const getGeoBtn = document.getElementById('get-geo-btn');
        const aiResponse = document.getElementById('ai-response');
        const relatedPlaces = document.getElementById('related-places');
        const relatedPlacesList = document.getElementById('related-places-list');
        const loading = document.getElementById('loading');
        const loadingSelection = document.getElementById('loading-selection');
        const loadingInput = document.getElementById('loading-input');

        // Store the AI response data globally
        let aiResponseData = null;

        // Function to update the selected types display
        function updateSelectedTypesDisplay() {
            const typesSelect = document.getElementById('ai-types');
            const selectedTypesDisplay = document.getElementById('selected-types-display');

            // Get selected options with their display text
            const selectedTypes = Array.from(typesSelect.selectedOptions).map(option => option.text);

            // Update the display
            if (selectedTypes.length > 0) {
                selectedTypesDisplay.textContent = selectedTypes.join(', ');
            } else {
                selectedTypesDisplay.textContent = 'No types selected';
            }
        }

        // Add event listener to types select box to update aiResponseData when selection changes
        document.getElementById('ai-types').addEventListener('change', function() {
            if (aiResponseData) {
                // Get selected options
                const selectedTypes = Array.from(this.selectedOptions).map(option => option.value);
                // Update aiResponseData
                aiResponseData.types = selectedTypes;
                // Update the selected types display
                updateSelectedTypesDisplay();
            }
        });

        // Function to update UI with AI response data
        function updateUIWithAIResponse(data) {
            // Store the AI response data
            aiResponseData = data;

            // Update UI with response
            document.getElementById('ai-name').textContent = data.name || '';

            // Handle types array for select box
            const typesSelect = document.getElementById('ai-types');
            // Clear all selections
            Array.from(typesSelect.options).forEach(option => {
                option.selected = false;
            });

            // Set selected options based on AI response
            if (data.types && Array.isArray(data.types)) {
                Array.from(typesSelect.options).forEach(option => {
                    // Check if this option's value is in the types array (case-insensitive)
                    const typeUpperCase = option.value.toUpperCase();
                    if (data.types.some(type => type.toUpperCase() === typeUpperCase)) {
                        option.selected = true;
                    }
                });
            }

            // Update the selected types display
            updateSelectedTypesDisplay();

            document.getElementById('ai-description').textContent = data.description || '';

            // Format location
            if (data.lat && data.lon) {
                document.getElementById('ai-location-lat').value = data.lat;
                document.getElementById('ai-location-lon').value = data.lon;
                document.getElementById('google-maps-link').href = `https://www.google.com/maps/search/${data.lat},${data.lon}`;
            } else {
                document.getElementById('ai-location-lat').value = '';
                document.getElementById('ai-location-lon').value = '';
                document.getElementById('google-maps-link').href = '#';
            }

            // Format address
            const address = [];
            if (data.street) address.push(data.street);
            if (data.city) address.push(data.city);
            if (data.zip_code) address.push(data.zip_code);
            if (data.country_code) address.push(data.country_code);
            document.getElementById('ai-address').textContent = address.join(', ');

            // Format age range
            if (data.min_age !== undefined && data.max_age !== undefined) {
                document.getElementById('ai-age-range').textContent = `${data.min_age} - ${data.max_age} years`;
            } else {
                document.getElementById('ai-age-range').textContent = '';
            }

            // Website with link
            if (data.website) {
                const link = document.createElement('a');
                link.href = data.website;
                link.textContent = data.website;
                link.target = '_blank';
                document.getElementById('ai-website').innerHTML = '';
                document.getElementById('ai-website').appendChild(link);
            } else {
                document.getElementById('ai-website').textContent = '';
            }

            // Admission
            if (data.is_admission_free !== undefined) {
                document.getElementById('ai-admission').textContent = data.is_admission_free ? 'Free' : 'Paid';
            } else {
                document.getElementById('ai-admission').textContent = 'Unknown';
            }

            // Season
            document.getElementById('ai-season').textContent = data.season || '';

            // Stroller friendly
            if (data.stroller_friendly !== undefined) {
                document.getElementById('ai-stroller').textContent = data.stroller_friendly ? 'Yes' : 'No';
            } else {
                document.getElementById('ai-stroller').textContent = 'Unknown';
            }

            // Car needed
            if (data.car_needed !== undefined) {
                document.getElementById('ai-car-needed').textContent = data.car_needed ? 'Yes' : 'No';
            } else {
                document.getElementById('ai-car-needed').textContent = 'Unknown';
            }

            // Show the AI response section
            aiResponse.style.display = 'block';
        }


            // Handle ASK AI from selection button click
            askAiSelectionBtn.addEventListener('click', function () {
                // Get the selected text
                const selectedText = window.getSelection().toString().trim();
                console.log('Selected text:', selectedText);
                if (!selectedText) {
                    alert('Please select some text first.');
                    return;
                }

                // Show loading indicator
                loadingSelection.style.display = 'inline-block';

                // Make API call
                fetch(`/admin/scraping/scrapedpost/ask_ai_from_selection/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        selected_text: selectedText
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Hide loading indicator
                        loadingSelection.style.display = 'none';

                        // Update UI with response
                        updateUIWithAIResponse(data);

                        // Update related places with nearby and similar name places
                        updateRelatedPlaces([], data.nearby_places || [], data.similar_name_places || []);
                    })
                    .catch(error => {
                        // Hide loading indicator
                        loadingSelection.style.display = 'none';

                        console.error('Error:', error);
                        alert('Error fetching AI response from selection: ' + error.message);
                    });
            });

            // Handle Ask AI from input button click
            askAiInputBtn.addEventListener('click', function () {
                // Show prompt to get user input
                const inputText = window.prompt('Enter text to analyze:');
                console.log('Input text:', inputText);
                if (!inputText) {
                    return; // User cancelled or entered empty text
                }

                // Show loading indicator
                loadingInput.style.display = 'inline-block';

                // Make API call
                fetch(`/admin/scraping/scrapedpost/ask_ai_from_input/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        input_text: inputText
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Hide loading indicator
                        loadingInput.style.display = 'none';

                        // Update UI with response
                        updateUIWithAIResponse(data);

                        // Update related places with nearby and similar name places
                        updateRelatedPlaces([], data.nearby_places || [], data.similar_name_places || []);
                    })
                    .catch(error => {
                        // Hide loading indicator
                        loadingInput.style.display = 'none';

                        console.error('Error:', error);
                        alert('Error fetching AI response from input: ' + error.message);
                    });
            });

            // Handle Save as place button click
            savePlaceBtn.addEventListener('click', function () {
                if (!aiResponseData) {
                    alert('No AI response data available. Please generate AI response first.');
                    return;
                }

                const postId = this.getAttribute('data-post-id');


                // Make API call to save the place
                fetch(`/admin/scraping/scrapedpost/save_as_place/${postId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(aiResponseData)
                })
                    .then(response => {
                        if (!response.ok) {
                            console.log(response)
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Show success message
                            alert(data.message);

                            // Update related places section
                            updateRelatedPlaces(data.related_places, data.nearby_places || [], data.similar_name_places || []);
                        } else {
                            alert('Error saving place: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error saving place: ' + error.message);
                    });
            });

            // Handle Get GEO button click
            getGeoBtn.addEventListener('click', function () {
                if (!aiResponseData) {
                    alert('No AI response data available. Please generate AI response first.');
                    return;
                }

                // Extract address components from AI response data
                const street = aiResponseData.street || '';
                const zipCode = aiResponseData.zip_code || '';
                const city = aiResponseData.city || '';
                const placeName = aiResponseData.name || '';
                const countryCode = aiResponseData.country_code || 'us';

                const placeId = this.getAttribute('data-post-id');

                // Call the geocode_place endpoint
                fetch(`/admin/scraping/scrapedpost/geocode/${placeId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        street: street,
                        zip_code: zipCode,
                        city: city,
                        place_name: placeName,
                        country_code: countryCode
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {

                        if (data.success) {
                            // Update the AI response data with the new lat/lon
                            aiResponseData.lat = data.lat;
                            aiResponseData.lon = data.lon;

                            // Update the UI - set input field values
                            document.getElementById('ai-location-lat').value = data.lat;
                            document.getElementById('ai-location-lon').value = data.lon;

                            // Update Google Maps link
                            updateGoogleMapsLink();

                            // Show success message
                            alert('Geocoding successful! Location updated.');
                        } else {
                            alert('Error geocoding address: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error geocoding address: ' + error.message);
                    });
            });

            // Function to update related places section
            function updateRelatedPlaces(places, nearbyPlaces = [], similarNamePlaces = []) {
                // Clear existing content
                relatedPlacesList.innerHTML = '';

                // Create a function to add places to the list with a header
                function addPlacesWithHeader(header, placesList) {
                    if (placesList && placesList.length > 0) {
                        // Add header
                        const headerElement = document.createElement('h4');
                        headerElement.textContent = header;
                        relatedPlacesList.appendChild(headerElement);

                        // Add each place
                        placesList.forEach(place => {
                            const placeItem = document.createElement('div');
                            placeItem.className = 'place-item';

                            const nameDiv = document.createElement('div');
                            nameDiv.innerHTML = `<strong>Name:</strong> <a href="/admin/place/place/${place.id}/change/">${place.name}</a>`;
                            placeItem.appendChild(nameDiv);

                            const typesDiv = document.createElement('div');
                            typesDiv.innerHTML = `<strong>Types:</strong> ${Array.isArray(place.type) ? place.type.join(', ') : ''}`;
                            placeItem.appendChild(typesDiv);

                            const cityDiv = document.createElement('div');
                            cityDiv.innerHTML = `<strong>City:</strong> ${place.city || ''}`;
                            placeItem.appendChild(cityDiv);

                            relatedPlacesList.appendChild(placeItem);
                        });
                    }
                }

                // Add places directly related to this ScrapedPlace
                if (places && places.length > 0) {
                    addPlacesWithHeader('Related Places', places);
                }

                // Add nearby places
                if (nearbyPlaces && nearbyPlaces.length > 0) {
                    addPlacesWithHeader('Places within 200 meters', nearbyPlaces);
                }

                // Add places with similar names
                if (similarNamePlaces && similarNamePlaces.length > 0) {
                    addPlacesWithHeader('Places with similar names', similarNamePlaces);
                }

                // If no places in any category, show no places message
                if ((!places || places.length === 0) && 
                    (!nearbyPlaces || nearbyPlaces.length === 0) && 
                    (!similarNamePlaces || similarNamePlaces.length === 0)) {
                    const noPlaces = document.createElement('p');
                    noPlaces.innerHTML = '<em>No related places found</em>';
                    relatedPlacesList.appendChild(noPlaces);
                }

                // Show the related places section
                relatedPlaces.style.display = 'block';
            }

            // Add event listeners for location input fields
            const locationLatInput = document.getElementById('ai-location-lat');
            const locationLonInput = document.getElementById('ai-location-lon');
            const googleMapsLink = document.getElementById('google-maps-link');

            // Update aiResponseData and Google Maps link when lat/lon inputs change
            locationLatInput.addEventListener('input', function() {
                if (aiResponseData) {
                    aiResponseData.lat = this.value;
                    updateGoogleMapsLink();
                }
            });

            locationLonInput.addEventListener('input', function() {
                if (aiResponseData) {
                    aiResponseData.lon = this.value;
                    updateGoogleMapsLink();
                }
            });

            // Function to update Google Maps link based on current lat/lon values
            function updateGoogleMapsLink() {
                const lat = locationLatInput.value.trim();
                const lon = locationLonInput.value.trim();

                if (lat && lon) {
                    googleMapsLink.href = `https://www.google.com/maps/search/${lat},${lon}`;
                } else {
                    googleMapsLink.href = '#';
                }
            }

            // Function to get CSRF token from cookies
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

    });
</script>
{% endblock %}
